<%- include('../partials/header') %>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üõ°Ô∏è User Management</h1>
        <div class="badge bg-danger p-2 fs-6">Admin Area</div>
    </div>

    <% if (success) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%= success %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>

    <div class="card shadow">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="bg-dark text-white">
                        <tr>
                            <th class="p-3">ID</th>
                            <th class="p-3">Username</th>
                            <th class="p-3">Email</th>
                            <th class="p-3">Role</th>
                            <th class="p-3">Joined</th>
                            <th class="p-3 text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% users.forEach(u => { %>
                            <tr>
                                <td class="p-3"><%= u.id %></td>
                                <td class="p-3 fw-bold"><%= u.username %></td>
                                <td class="p-3"><%= u.email %></td>
                                <td class="p-3">
                                    <% if (u.role === 'admin') { %>
                                        <span class="badge bg-danger">ADMIN</span>
                                    <% } else if (u.role === 'author') { %>
                                        <span class="badge bg-primary">AUTHOR</span>
                                    <% } else { %>
                                        <span class="badge bg-primary">AUTHOR</span>
                                    <% } %>
                                </td>
                                <td class="p-3"><%= new Date(u.created_at).toLocaleDateString() %></td>
                                <td class="p-3 text-end">
                            <% if (u.id !== user.id) { %>
                                        <button type="button" class="btn btn-sm btn-outline-primary me-1" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editRoleModal<%= u.id %>">
                                            Change Role
                                        </button>
                                        <form action="/admin/users/<%= u.id %>/delete" method="POST" class="d-inline"
                                              onsubmit="return confirm('‚ö†Ô∏è DANGER: This will delete the user and ALL their posts! Are you sure?')">
                                            <button class="btn btn-sm btn-outline-danger">Delete</button>
                                        </form>
                                    <% } else { %>
                                        <span class="text-muted fst-italic">Current User</span>
                                    <% } %>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modals Section (Moved outside table to prevent z-index issues) -->
<% users.forEach(u => { %>
    <% if (u.id !== user.id) { %>
        <div class="modal fade" id="editRoleModal<%= u.id %>" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/admin/users/role" method="POST">
                        <div class="modal-header">
                            <h5 class="modal-title">Change Role for <%= u.username %></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="userId" value="<%= u.id %>">
                            <div class="mb-3">
                                <label class="form-label">Select New Role:</label>
                                <select name="newRole" class="form-select">
                                                                    <option value="author" <%= u.role === 'author' ? 'selected' : '' %>>Author (Can write posts)</option>
                                    <option value="admin" <%= u.role === 'admin' ? 'selected' : '' %>>Admin (Full access)</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    <% } %>
<% }) %>

<%- include('../partials/footer') %>
